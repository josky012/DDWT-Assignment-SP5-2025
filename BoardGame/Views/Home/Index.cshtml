@using WebMatrix.Data;

@{
    var db = Database.Open("BoardGame");
    var q = Request["q"];
    var view = (Request["view"] ?? "table").ToLower();

    // List of games
    var sql =
        "SELECT BG.*, GF.Family " +
        "FROM BoardGame BG " +
        "LEFT JOIN GameFamily GF ON BG.Family = GF.FamilyCode";

    if (!String.IsNullOrWhiteSpace(q))
    {
        sql += " WHERE BG.Name LIKE @0";
    }

    sql += " ORDER BY BG.Name";

    var data = db.Query(sql, "%" + q + "%");
}


<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Board Games</title>
    <!--  Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="p-4">
    <div class="container">

        <h2 class="mb-3">Board Games</h2>
        <p class="mb-4">This page displays board game information from the database.</p>

        <!-- search and view selector -->
        <form method="get" class="row g-2 mb-4">
            <div class="col-sm-6">
                <input class="form-control" type="text" name="q" value="@q" placeholder="Search by name" />
            </div>
            <div class="col-sm-3">
                <select class="form-select" name="view">
                    <option value="table" @(view == "table" ? "selected" : "")>Table View</option>
                    <option value="card" @(view == "card" ? "selected" : "")>Card View</option>
                </select>
            </div>
            <div class="col-sm-3 d-grid">
                <button type="submit" class="btn btn-primary">Apply</button>
            </div>
        </form>


        @if (view == "card")
        {
            <!-- Card view -->
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
                @foreach (var row in data)
                {
                    var catsSql = "SELECT GC.Category " +
                                   "FROM GameCategory GC " +
                                   "WHERE GC.BGGID = @0 ORDER BY GC.Category";
                    var cats = db.Query(catsSql, row.BGGID);

                    <div class="col">
                        <div class="card h-100">
                            <img src="@row.imagePath" class="card-img-top" alt="@row.Name" style="object-fit:cover;height:180px;">
                            <div class="card-body">
                                <h5 class="card-title">@row.Name</h5>

                                <p class="card-text small mb-1"><strong>Year Published:</strong> @(row.YearPublished ?? "—")</p>
                                <p class="card-text small mb-1"><strong>Players:</strong> @row.MinPlayers - @row.MaxPlayers</p>
                                <p class="card-text small mb-1">
                                    <strong>Mfg Play Time:</strong> @(row.MfgPlayTime ?? "—")<br />
                                    <strong>Com Play Time:</strong> @(row.ComMinPlayTime ?? "—") - @(row.ComMaxPlayTime ?? "—")
                                </p>
                                <p class="card-text small mb-1"><strong>Family:</strong> @(row.Family ?? "—")</p>

                                <p class="card-text small mb-2">
                                    <strong>Categories:</strong>
                                    @{
                                        var catList = "";
                                        foreach (var c in cats)
                                        {
                                            if (catList != "") { catList += ", "; }
                                            catList += c.Category;
                                        }
                                        if (String.IsNullOrEmpty(catList)) { catList = "—"; }
                                    }
                                    @catList
                                </p>

                                <!-- Description from Board Game -->
                                <p class="card-text small mb-0">
                                    <strong>Description:</strong><br />
                                    @(String.IsNullOrWhiteSpace((string)row.Description) ? "—" : (string)row.Description)
                                </p>
                                <!-- Edit button added -->
                                <p class="mt-3">
                                    <a class="btn btn-sm btn-outline-primary" href="/Views/Home/Details.cshtml?id=@row.BGGID">Details</a>
                                    <a class="btn btn-sm btn-outline-secondary" href="/Views/Home/Edit.cshtml?id=@row.BGGID">Edit</a>
                                </p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- Table view-->
            <div class="table-responsive">
                <table class="table table-bordered align-middle table-sm">
                    <thead class="table-light">
                        <tr class="text-nowrap">
                            <th>Name</th>
                            <th>Description</th>
                            <th>Year Published</th>
                            <th>Game Weight</th>
                            <th>Min Players</th>
                            <th>Max Players</th>
                            <th>Mfg Play Time</th>
                            <th>Com Min</th>
                            <th>Com Max</th>
                            <th>Mfg Age Rec</th>
                            <th>Com Age Rec</th>
                            <th>Language Ease</th>
                            <th>Best Players</th>
                            <th>Num Owned</th>
                            <th>Num Want</th>
                            <th>Num Wish</th>
                            <th>Num Expansions</th>
                            <th>Num Implementations</th>
                            <th>Rank Board</th>
                            <th>Rank Strategy</th>
                            <th>Rank Family</th>
                            <th>Rank Thematic</th>
                            <th>Family</th>
                            <th>imagePath</th>
                            <th>Details</th>
                            <th>Edit</th>

                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in data)
                        {
                            <tr>
                                <td>@row.Name</td>
                                <td style="min-width:260px;max-width:520px;white-space:normal;">
                                    @(String.IsNullOrWhiteSpace((string)row.Description) ? "—" : (string)row.Description)
                                </td>
                                <td>@(row.YearPublished ?? "—")</td>
                                <td>@(row.GameWeight ?? "—")</td>
                                <td>@row.MinPlayers</td>
                                <td>@row.MaxPlayers</td>
                                <td>@(row.MfgPlayTime ?? "—")</td>
                                <td>@(row.ComMinPlayTime ?? "—")</td>
                                <td>@(row.ComMaxPlayTime ?? "—")</td>
                                <td>@(row.MfgAgeRec ?? "—")</td>
                                <td>@(row.ComAgeRec ?? "—")</td>
                                <td>@(row.LanguageEase ?? "—")</td>
                                <td>@(row.BestPlayers ?? "—")</td>
                                <td>@(row.NumOwned ?? "—")</td>
                                <td>@(row.NumWant ?? "—")</td>
                                <td>@(row.NumWish ?? "—")</td>
                                <td>@(row.NumExpansions ?? "—")</td>
                                <td>@(row.NumImplementations ?? "—")</td>
                                <td>@(row.RankInboardgame ?? "—")</td>
                                <td>@(row.RankInstrategygames ?? "—")</td>
                                <td>@(row.RankInfamilygames ?? "—")</td>
                                <td>@(row.RankInthematic ?? "—")</td>
                                <td>@(row.Family ?? "—")</td>
                                <td class="text-truncate" style="max-width:260px;">@(row.imagePath ?? "—")</td>
                                <td> <a class="btn btn-sm btn-outline-primary" href="/Views/Home/Details.cshtml?id=@row.BGGID">Details</a> </td>
                                <td> <a class="btn btn-sm btn-outline-secondary" href="/Views/Home/Edit.cshtml?id=@row.BGGID">Edit</a> </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</body>
</html>