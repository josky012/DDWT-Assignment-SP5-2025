@using WebMatrix.Data;

@{
    var db = Database.Open("BoardGame");
    var q = Request["q"];
    var view = (Request["view"] ?? "table").ToLower();

    // List of games 
    var sql = "SELECT BGGID, Name, YearPublished, MinPlayers, MaxPlayers, " +
              "MfgPlayTime, ComMinPlayTime, ComMaxPlayTime, Family, imagePath " +
              "FROM BoardGame";

    if (!String.IsNullOrWhiteSpace(q))
    {
        sql += " WHERE Name LIKE @0";
    }

    sql += " ORDER BY Name";

    var data = db.Query(sql, "%" + q + "%");
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Board Games</title>
    <!--  Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="p-4">
    <div class="container">

        <h2 class="mb-3">Board Games</h2>
        <p class="mb-4">This page displays board game information from the database.</p>

        <!-- search and view selector -->
        <form method="get" class="row g-2 mb-4">
            <div class="col-sm-6">
                <input class="form-control" type="text" name="q" value="@q" placeholder="Search by name" />
            </div>
            <div class="col-sm-3">
                <select class="form-select" name="view">
                    <option value="table" @(view == "table" ? "selected" : "")>Table View</option>
                    <option value="card" @(view == "card" ? "selected" : "")>Card View</option>
                </select>
            </div>
            <div class="col-sm-3 d-grid">
                <button type="submit" class="btn btn-primary">Apply</button>
            </div>
        </form>

        @if (view == "card")
        {
            <!-- Card view-->
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
                @foreach (var row in data)
                    {
                        var catsSql = "SELECT GC.Category " +
                                       "FROM GameCategory GC " +
                                       "WHERE GC.BGGID = @0 ORDER BY GC.Category";
                        var cats = db.Query(catsSql, row.BGGID);

                        <div class="col">
                            <div class="card h-100">
                                <img src="@row.imagePath" class="card-img-top" alt="@row.Name" style="object-fit:cover;height:180px;">
                                <div class="card-body">
                                    <h5 class="card-title">@row.Name</h5>

                                    <p class="card-text small mb-1"><strong>Year Published:</strong> @(row.YearPublished ?? "—")</p>
                                    <p class="card-text small mb-1"><strong>Players:</strong> @row.MinPlayers - @row.MaxPlayers</p>
                                    <p class="card-text small mb-1">
                                        <strong>Mfg Play Time:</strong> @(row.MfgPlayTime ?? "—")<br />
                                        <strong>Com Play Time:</strong> @(row.ComMinPlayTime ?? "—") - @(row.ComMaxPlayTime ?? "—")
                                    </p>
                                    <p class="card-text small mb-1"><strong>Family:</strong> @(row.Family ?? "—")</p>

                                    <p class="card-text small mb-0"><strong>Categories:</strong>
                                        @{
                                            var catList = "";
                                            foreach (var c in cats)
                                            {
                                                if (catList != "") { catList += ", "; }
                                                catList += c.Category;
                                            }
                                            if (String.IsNullOrEmpty(catList)) { catList = "—"; }
                                        }
                                        @catList
                                    </p>
                                </div>
                            </div>
                        </div>
                    }
            </div>
        }
        else
        {
            <!-- Table view-->
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Year Published</th>
                            <th>Min Players</th>
                            <th>Max Players</th>
                            <th>Mfg Play Time</th>
                            <th>Com Play Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in data)
                        {
                            <tr>
                                <td>@row.Name</td>
                                <td>@(row.YearPublished ?? "—")</td>
                                <td>@row.MinPlayers</td>
                                <td>@row.MaxPlayers</td>
                                <td>@row.MfgPlayTime</td>
                                <td>@row.ComMinPlayTime - @row.ComMaxPlayTime</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</body>
</html>
